import React, { useState, useEffect, useRef } from 'react';
import { 
  Activity, Clock, Flame, CheckCircle, ChevronDown, ChevronRight, 
  AlertTriangle, Eye, X, Check, Dumbbell, Zap, HeartPulse, 
  Utensils, Calendar, ShieldAlert, Edit2, Save, TrendingUp, HelpCircle,
  Sparkles, MessageSquare, ChefHat, RefreshCw, Send, Loader2, List, LineChart, ClipboardPaste, Trash2
} from 'lucide-react';

// --- COMPONENTES VISUALES ---
const ExerciseIcon = ({ type }) => {
  if (type.includes('Cardio')) return <div className="p-3 bg-orange-100 text-orange-600 rounded-2xl shrink-0"><HeartPulse size={24} /></div>;
  if (type.includes('Fuerza')) return <div className="p-3 bg-blue-100 text-blue-600 rounded-2xl shrink-0"><Dumbbell size={24} /></div>;
  return <div className="p-3 bg-emerald-100 text-emerald-600 rounded-2xl shrink-0"><Zap size={24} /></div>;
};

// --- COMPONENTE DE GR√ÅFICA (SVG SIMPLE) ---
const WeightChart = ({ data }) => {
  if (!data || data.length < 1) return (
    <div className="h-40 flex items-center justify-center bg-slate-50 rounded-xl text-slate-400 text-xs italic">
      Registra m√°s pesos para ver evoluci√≥n
    </div>
  );

  if (data.length === 1) {
     return (
        <div className="h-40 flex flex-col items-center justify-center bg-slate-50 rounded-xl text-slate-500">
           <p className="text-3xl font-bold text-slate-800">{data[0].weight} kg</p>
           <p className="text-xs uppercase font-bold mt-2">Inicio: {data[0].date}</p>
        </div>
     )
  }

  const padding = 20;
  const width = 300;
  const height = 150;
  
  const weights = data.map(d => d.weight);
  const minWeight = Math.min(...weights) - 1;
  const maxWeight = Math.max(...weights) + 1;
  
  const points = data.map((d, i) => {
    const x = (i / (data.length - 1)) * (width - padding * 2) + padding;
    const y = height - ((d.weight - minWeight) / (maxWeight - minWeight)) * (height - padding * 2) - padding;
    return `${x},${y}`;
  }).join(' ');

  return (
    <div className="w-full overflow-hidden">
      <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full drop-shadow-sm">
        <line x1={padding} y1={height/2} x2={width-padding} y2={height/2} stroke="#e2e8f0" strokeDasharray="4" />
        <polyline fill="none" stroke="#ef4444" strokeWidth="3" points={points} strokeLinecap="round" strokeLinejoin="round" />
        {data.map((d, i) => {
          const x = (i / (data.length - 1)) * (width - padding * 2) + padding;
          const y = height - ((d.weight - minWeight) / (maxWeight - minWeight)) * (height - padding * 2) - padding;
          return (
            <g key={i}>
              <circle cx={x} cy={y} r="4" fill="white" stroke="#ef4444" strokeWidth="2" />
              {(i === 0 || i === data.length - 1) && (
                <text x={x} y={y - 10} textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">{d.weight}</text>
              )}
            </g>
          );
        })}
      </svg>
      <div className="flex justify-between px-2 text-[10px] text-slate-400 mt-1 uppercase font-bold">
        <span>Inicio ({data[0].date})</span>
        <span>Actual ({data[data.length-1].date})</span>
      </div>
    </div>
  );
};

const GymAppVisual = () => {
  // --- ESTADO Y DATOS ---
  const [userProfile, setUserProfile] = useState({
    age: 52, weight: 106.1, height: 173, diet: 'Ayuno 16/8', bmi: '35.4',
    injury: 'Dolor rodilla izquierda al bajar escaleras (S√≠ndrome femoropatelar posible), esguince antiguo tobillo.'
  });
  
  const [weightHistory, setWeightHistory] = useState([
    { date: '04/12/2025', weight: 106.1, bmi: '35.4' }
  ]);

  const [currentDate, setCurrentDate] = useState('');
  const [isEditingWeight, setIsEditingWeight] = useState(false);
  const [tempWeight, setTempWeight] = useState(106.1);
  const [showStats, setShowStats] = useState(false); 
  const [statsView, setStatsView] = useState('chart'); 

  const [activeTab, setActiveTab] = useState('routine');
  const [expandedDay, setExpandedDay] = useState('Hoy'); // Por defecto abrimos "Hoy" si hay rutina importada
  const [selectedMachine, setSelectedMachine] = useState(null);
  const [currentPhase, setCurrentPhase] = useState('phase1');
  const [exerciseLogs, setExerciseLogs] = useState({});

  // --- NUEVO ESTADO: RUTINA IMPORTADA ---
  const [todaysRoutine, setTodaysRoutine] = useState(null); // Aqu√≠ guardaremos la rutina parseada por IA

  // IA States
  const [aiMode, setAiMode] = useState('import'); // 'chat', 'alternative', 'recipe', 'import'
  const [aiInput, setAiInput] = useState('');
  const [aiResponse, setAiResponse] = useState('');
  const [isLoadingAI, setIsLoadingAI] = useState(false);
  const [chatHistory, setChatHistory] = useState([]);
  const chatEndRef = useRef(null);

  const apiKey = ""; 

  useEffect(() => {
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateString = today.toLocaleDateString('es-ES', options);
    setCurrentDate(dateString.charAt(0).toUpperCase() + dateString.slice(1));
  }, []);

  useEffect(() => {
    const heightM = userProfile.height / 100;
    const newBmi = (userProfile.weight / (heightM * heightM)).toFixed(1);
    setUserProfile(prev => ({ ...prev, bmi: newBmi }));
  }, [userProfile.weight]);

  const handleWeightSave = () => {
    const weightVal = tempWeight === '' ? 0 : parseFloat(tempWeight);
    const heightM = userProfile.height / 100;
    const newBmi = (weightVal / (heightM * heightM)).toFixed(1);
    setUserProfile(prev => ({ ...prev, weight: weightVal, bmi: newBmi }));
    const today = new Date();
    const dateStr = today.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    setWeightHistory(prev => [...prev, { date: dateStr, weight: weightVal, bmi: newBmi }]);
    setIsEditingWeight(false);
  };

  const handleLogChange = (exerciseId, value) => {
    setExerciseLogs(prev => ({ ...prev, [exerciseId]: value }));
  };

  // --- FUNCI√ìN LLAMADA A GEMINI API (CON PARSEO) ---
  const callGemini = async (promptType, userInput) => {
    setIsLoadingAI(true);
    setAiResponse('');
    
    let systemInstruction = `
      Act√∫a como un entrenador personal experto.
    `;
    let finalPrompt = "";

    if (promptType === 'parse_routine') {
      systemInstruction = `
        Eres un asistente que convierte TEXTO libre de rutinas de gimnasio a JSON estructurado.
        Recibir√°s un texto con una rutina diaria.
        Debes extraer una lista de ejercicios.
        
        Devuelve SOLO un objeto JSON con este formato exacto (sin markdown, sin explicaciones):
        {
          "title": "T√≠tulo de la rutina o fecha",
          "focus": "Objetivo principal detectado (ej: Fullbody, Torso, Pierna)",
          "exercises": [
            {
              "id": 1,
              "name": "Nombre del ejercicio",
              "sets": "Resumen series/reps (ej: 3x12 o 13kg/18kg)",
              "note": "Consejos t√©cnicos, claves o detalles de peso espec√≠ficos",
              "type": "Fuerza" o "Cardio" (seg√∫n corresponda),
              "hasWeight": true (si es de pesas/m√°quina) o false (si es cardio/estiramiento),
              "machineId": "legpress" | "legextension" | "latpulldown" | null (Solo si identificas CLARAMENTE una de estas m√°quinas, si no null)
            }
          ]
        }
        
        Mapeo de machineId:
        - "legpress": Prensa, prensa inclinada, trineo.
        - "legextension": Extensi√≥n cu√°driceps, sill√≥n cu√°driceps.
        - "latpulldown": Jal√≥n al pecho, polea alta espalda.
      `;
      finalPrompt = `Analiza y extrae la rutina de este texto:\n\n${userInput}`;
    } else {
        // ... (resto de prompts anteriores)
        if (promptType === 'chat') finalPrompt = `Usuario (52 a√±os, dolor rodilla): "${userInput}". Responde corto.`;
        else if (promptType === 'alternative') finalPrompt = `Alternativa segura rodilla a: "${userInput}".`;
        else if (promptType === 'recipe') finalPrompt = `Receta ayuno con: "${userInput}".`;
    }

    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: systemInstruction + "\n\n" + finalPrompt }] }] })
        }
      );
      const data = await response.json();
      let textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error.";
      
      if (promptType === 'parse_routine') {
        // Limpiar bloques de c√≥digo markdown si la IA los pone
        textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
        try {
          const parsedRoutine = JSON.parse(textResponse);
          setTodaysRoutine(parsedRoutine);
          setAiInput(''); // Limpiar input
          setAiMode('import'); // Mantenerse en import o cambiar
          setActiveTab('routine'); // Llevar al usuario a ver su rutina
          setExpandedDay('Hoy'); // Abrir la rutina importada
        } catch (e) {
          console.error("Error parsing JSON:", e);
          setAiResponse("‚ö†Ô∏è No pude entender el formato. Intenta pegar solo la lista de ejercicios.");
        }
      } else if (promptType === 'chat') {
        setChatHistory(prev => [...prev, { role: 'user', text: userInput }, { role: 'ai', text: textResponse }]);
        setAiInput('');
      } else {
        setAiResponse(textResponse);
      }
    } catch (error) {
      console.error(error);
      setAiResponse("‚ö†Ô∏è Error de conexi√≥n.");
    } finally {
      setIsLoadingAI(false);
    }
  };

  const machineVisuals = {
    'legpress': {
      name: 'Prensa de Piernas',
      image: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=600&auto=format&fit=crop',
      checklist: ['Respaldo inclinado', 'Pies parte SUPERIOR', 'Rodillas semiflexionadas'],
      warning: 'Sustituto seguro de la sentadilla.'
    },
    'legextension': {
      name: 'Extensi√≥n Cu√°driceps',
      image: 'https://images.unsplash.com/photo-1574680096145-d05b474e2155?q=80&w=600&auto=format&fit=crop',
      checklist: ['Rodillo sobre empeine', 'Eje alineado con rodilla', 'No mover, solo aguantar'],
      warning: 'Ejercicio est√°tico para no da√±ar cart√≠lago.'
    },
    'latpulldown': {
      name: 'Jal√≥n al Pecho',
      image: 'https://images.unsplash.com/photo-1598971639058-211a73287750?q=80&w=600&auto=format&fit=crop',
      checklist: ['Rodillos apretados', 'Barra al pecho alto', 'Espalda recta'],
      warning: 'Nunca tras nuca.'
    }
  };

  const renderMachineModalContent = (machineKey) => {
    const machine = machineVisuals[machineKey];
    if (!machine) return null;
    return (
        <>
            <div className="relative w-full h-56 rounded-2xl overflow-hidden shadow-md group">
                <img src={machine.image} alt={machine.name} className="w-full h-full object-cover" onError={(e) => { e.target.src = 'https://placehold.co/600x400?text=Maquina'; }} />
                {machineKey === 'legpress' && <div className="absolute top-2 right-2 bg-red-100 text-red-600 text-[10px] font-bold px-3 py-1.5 rounded-full border border-red-200 shadow-sm z-10 animate-pulse">¬°PIES ARRIBA!</div>}
                {machineKey === 'legextension' && <div className="absolute bottom-2 left-2 bg-blue-100 text-blue-800 text-[10px] font-bold px-3 py-1.5 rounded-full border border-blue-200 shadow-sm z-10">ISOM√âTRICO</div>}
                {machineKey === 'latpulldown' && <div className="absolute top-2 left-2 bg-emerald-100 text-emerald-800 text-[10px] font-bold px-3 py-1.5 rounded-full border border-emerald-200 shadow-sm z-10">POSTURA</div>}
            </div>
            <div className="mt-8 space-y-4">
                <div className="bg-amber-50 p-5 rounded-3xl border border-amber-100 flex gap-4"><AlertTriangle className="text-amber-500 shrink-0" size={24} /><p className="text-sm text-amber-900 font-medium leading-relaxed">{machine.warning}</p></div>
            </div>
        </>
    );
  };

  // Datos Hardcoded (Backup)
  const routinesByPhase = {
    'phase1': { title: 'Fase 1', description: 'Rutina Est√°ndar Base', data: { 'D√≠a 1': { focus: 'Rodilla Segura', color: 'from-blue-500 to-indigo-600', exercises: [{ id: 1, type: 'Cardio', name: 'Bici Est√°tica', sets: '10 min', note: 'Ritmo suave.', machineId: null }] } } }
  };
  const currentRoutine = routinesByPhase['phase1'];

  return (
    <div className="flex flex-col h-screen bg-gray-50 font-sans text-slate-800 overflow-hidden">
      
      {/* HEADER VISUAL */}
      <div className="bg-white px-6 pt-10 pb-6 rounded-b-[2.5rem] shadow-lg z-10 relative flex-shrink-0">
        <div className="flex justify-between items-start mb-6">
          <div className="flex-1">
            <p className="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-0.5 flex items-center gap-1"><Calendar size={10} />{currentDate}</p>
            <h1 className="text-3xl font-extrabold text-red-600 tracking-tight leading-none italic mt-1">JUANKAR <span className="text-slate-800 not-italic">GYM</span></h1>
          </div>
          <button onClick={() => setShowStats(true)} className="bg-blue-50 p-1 pr-4 rounded-2xl flex items-center gap-3 border border-blue-100 shadow-sm active:scale-95 transition-all ml-4 max-w-[50%]">
             <div className="bg-white p-2.5 rounded-xl shadow-sm text-blue-600"><TrendingUp size={18} /></div>
             <div className="text-right"><div className="text-xl font-black text-slate-800 leading-none">{userProfile.weight} <span className="text-xs text-slate-400 font-bold">kg</span></div><div className="text-[10px] text-blue-500 font-bold bg-blue-100/50 px-1.5 rounded mt-0.5 inline-block">IMC: {userProfile.bmi}</div></div>
          </button>
        </div>
        
        {/* Si hay rutina importada, mostramos aviso */}
        {todaysRoutine ? (
           <div className="bg-emerald-50 border border-emerald-100 p-3 rounded-xl flex items-center justify-between animate-fadeIn">
              <div className="flex items-center gap-2">
                 <ClipboardPaste className="text-emerald-600" size={16} />
                 <span className="text-xs font-bold text-emerald-800">Rutina Personalizada Activa</span>
              </div>
              <button onClick={() => setTodaysRoutine(null)} className="p-1.5 bg-white text-red-500 rounded-lg shadow-sm"><Trash2 size={14} /></button>
           </div>
        ) : (
           <p className="text-xs text-slate-500 text-center italic mb-2">Usando Plan Est√°ndar (Importa tu rutina en el Asistente)</p>
        )}
      </div>

      <div className="flex-1 overflow-y-auto px-6 py-6 space-y-6 scrollbar-hide pb-32">
        <div className="sticky top-0 z-20 bg-gray-50/95 backdrop-blur-sm pt-2 pb-2">
            <div className="bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100 flex relative">
              <div className={`absolute top-1.5 bottom-1.5 w-[calc(33.33%-4px)] bg-slate-900 rounded-xl transition-all duration-300 ease-out shadow-lg ${activeTab === 'nutrition' ? 'translate-x-[100%] ml-1' : ''} ${activeTab === 'ai' ? 'translate-x-[200%] ml-2' : ''} ${activeTab === 'routine' ? 'translate-x-0' : ''}`}></div>
              <button onClick={() => setActiveTab('routine')} className={`flex-1 py-3 text-xs sm:text-sm font-bold rounded-xl relative z-10 transition-colors ${activeTab === 'routine' ? 'text-white' : 'text-slate-400'}`}>Rutina</button>
              <button onClick={() => setActiveTab('nutrition')} className={`flex-1 py-3 text-xs sm:text-sm font-bold rounded-xl relative z-10 transition-colors ${activeTab === 'nutrition' ? 'text-white' : 'text-slate-400'}`}>Nutrici√≥n</button>
              <button onClick={() => setActiveTab('ai')} className={`flex-1 py-3 text-xs sm:text-sm font-bold rounded-xl relative z-10 transition-colors flex items-center justify-center gap-1 ${activeTab === 'ai' ? 'text-white' : 'text-slate-400'}`}><Sparkles size={14} /> Asistente</button>
            </div>
        </div>

        {activeTab === 'routine' && (
          <div className="space-y-4 animate-fadeIn">
            {/* RENDERIZADO DIN√ÅMICO DE RUTINA */}
            {(todaysRoutine ? {'Hoy': {...todaysRoutine, color: 'from-emerald-500 to-teal-600'}} : currentRoutine.data) && 
              Object.entries(todaysRoutine ? {'Hoy': {...todaysRoutine, color: 'from-emerald-500 to-teal-600'}} : currentRoutine.data).map(([day, data]) => {
                const isExpanded = expandedDay === day;
                return (
                  <div key={day} className={`bg-white rounded-[2rem] overflow-hidden transition-all duration-300 ease-in-out border border-slate-100 ${isExpanded ? 'shadow-xl shadow-blue-50 ring-2 ring-blue-50' : 'shadow-sm'}`}>
                    <button onClick={() => setExpandedDay(isExpanded ? null : day)} className="w-full p-5 flex items-center justify-between bg-white relative overflow-hidden active:bg-slate-50">
                      <div className="flex items-center gap-4 z-10">
                        <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-white bg-gradient-to-br ${data.color} shadow-lg`}><Calendar size={24} /></div>
                        <div className="text-left"><h3 className="font-bold text-slate-800 text-lg">{data.title || day}</h3><p className="text-xs text-slate-400 font-medium uppercase tracking-wider">{data.focus || 'Rutina Diaria'}</p></div>
                      </div>
                      <ChevronDown size={28} className={`transition-transform duration-300 ${isExpanded ? 'rotate-180 text-blue-500' : 'text-slate-300'}`} />
                    </button>
                    {isExpanded && (
                      <div className="px-4 pb-6 pt-2 space-y-4 bg-white">
                        <div className="h-px w-full bg-slate-50 mb-4"></div>
                        {data.exercises.map((ex) => (
                          <div key={ex.id} className="relative bg-slate-50 border border-slate-100 p-4 rounded-3xl active:scale-[0.99] transition-transform">
                            {ex.machineId && machineVisuals[ex.machineId] && (
                                <button onClick={(e) => { e.stopPropagation(); setSelectedMachine(ex.machineId); }} className="absolute right-4 top-4 w-16 h-16 rounded-xl overflow-hidden border border-slate-200 shadow-sm hover:ring-2 hover:ring-blue-400 transition-all z-20">
                                  <img src={machineVisuals[ex.machineId].image} alt="M√°quina" className="w-full h-full object-cover" onError={(e) => { e.target.src = 'https://placehold.co/100x100?text=Foto'; }} />
                                </button>
                            )}
                            <div className="flex items-start gap-4 mb-4 pr-16">
                              <ExerciseIcon type={ex.type} />
                              <div className="flex-1">
                                <div className="flex flex-col mb-1"><h4 className="font-bold text-slate-800 text-base">{ex.name}</h4><span className="text-[10px] font-black bg-slate-200 text-slate-600 px-2 py-0.5 rounded w-fit mt-1">{ex.sets}</span></div>
                                <p className="text-sm text-slate-500 leading-snug whitespace-pre-line">{ex.note}</p>
                              </div>
                            </div>
                            {ex.hasWeight && (
                              <div className="flex items-center justify-between gap-3 mt-3 pt-3 border-t border-slate-200/60">
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Carga (Kg):</span>
                                <div className="flex items-center bg-white border border-slate-200 rounded-xl px-4 py-2 shadow-sm w-36">
                                  <input type="number" inputMode="decimal" step="0.5" placeholder="0" value={exerciseLogs[ex.id] || ''} onChange={(e) => handleLogChange(ex.id, e.target.value)} className="w-full text-lg font-bold text-slate-800 outline-none placeholder:text-slate-200" />
                                  <span className="text-sm text-slate-400 font-bold ml-1">Kg</span>
                                </div>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
            })}
          </div>
        )}

        {activeTab === 'nutrition' && (
             <div className="bg-gradient-to-br from-orange-400 to-orange-600 rounded-[2rem] p-8 text-white shadow-xl shadow-orange-100 relative overflow-hidden">
               <Flame className="absolute -right-4 -bottom-4 text-white opacity-20" size={140} />
               <div className="relative z-10"><h2 className="text-3xl font-bold mb-3">Ayuno 16/8</h2><p className="text-orange-100 text-base leading-relaxed mb-6">√öltima comida: prote√≠na sagrada.</p></div>
            </div>
        )}

        {activeTab === 'ai' && (
          <div className="space-y-6 animate-fadeIn pb-10">
            <div className="grid grid-cols-4 gap-2">
              <button onClick={() => setAiMode('import')} className={`flex flex-col items-center justify-center p-3 rounded-2xl border transition-all col-span-2 ${aiMode === 'import' ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-400'}`}><ClipboardPaste size={20} className="mb-1" /><span className="text-[10px] font-bold uppercase">üì• Importar Rutina</span></button>
              <button onClick={() => setAiMode('chat')} className={`flex flex-col items-center justify-center p-3 rounded-2xl border transition-all ${aiMode === 'chat' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-400'}`}><MessageSquare size={20} className="mb-1" /><span className="text-[10px] font-bold uppercase">Chat</span></button>
              <button onClick={() => setAiMode('recipe')} className={`flex flex-col items-center justify-center p-3 rounded-2xl border transition-all ${aiMode === 'recipe' ? 'bg-orange-500 text-white shadow-lg' : 'bg-white text-slate-400'}`}><ChefHat size={20} className="mb-1" /><span className="text-[10px] font-bold uppercase">Receta</span></button>
            </div>

            {/* MODO IMPORTAR RUTINA */}
            {aiMode === 'import' && (
              <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                 <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><ClipboardPaste className="text-slate-500"/> Conversor de Rutinas</h3>
                 <p className="text-sm text-slate-500 mb-4">Copia el mensaje de WhatsApp de tu entrenador y p√©galo aqu√≠. La IA crear√° tu pantalla de entrenamiento.</p>
                 <textarea 
                    placeholder="Pega aqu√≠ tu rutina completa..." 
                    className="w-full h-40 bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm outline-none focus:border-blue-500 mb-4 font-mono"
                    value={aiInput}
                    onChange={(e) => setAiInput(e.target.value)}
                 />
                 <button 
                    onClick={() => callGemini('parse_routine', aiInput)}
                    className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-lg"
                    disabled={isLoadingAI || !aiInput.trim()}
                 >
                    {isLoadingAI ? <Loader2 className="animate-spin" /> : '‚ú® Convertir en App'}
                 </button>
              </div>
            )}

            {/* MODO CHAT */}
            {aiMode === 'chat' && (
              <div className="flex flex-col h-[50vh] bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                <div className="flex-1 p-4 overflow-y-auto space-y-3 bg-slate-50/30">
                  {chatHistory.map((msg, idx) => <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] p-3 rounded-2xl text-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-100 text-slate-700 rounded-tl-none shadow-sm'}`}>{msg.text}</div></div>)}
                  {isLoadingAI && <div className="flex justify-start"><div className="bg-white border border-slate-100 p-3 rounded-2xl flex items-center gap-2"><Loader2 size={16} className="animate-spin text-indigo-500" /><span className="text-xs text-slate-400">...</span></div></div>}
                  <div ref={chatEndRef} />
                </div>
                <div className="p-3 bg-white border-t border-slate-100 flex gap-2">
                  <input type="text" placeholder="Pregunta..." className="flex-1 bg-slate-100 rounded-full px-4 text-sm outline-none" value={aiInput} onChange={(e) => setAiInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && callGemini('chat', aiInput)} />
                  <button onClick={() => callGemini('chat', aiInput)} disabled={!aiInput.trim() || isLoadingAI} className="p-2 bg-indigo-600 text-white rounded-full disabled:opacity-50"><Send size={18} /></button>
                </div>
              </div>
            )}
            
            {/* MODO RECETA (Simplificado para ahorrar espacio en esta vista) */}
            {aiMode === 'recipe' && (
               <div className="bg-white rounded-[2rem] p-6 text-center text-slate-400 text-sm">Pr√≥ximamente...</div>
            )}
          </div>
        )}
      </div>

      {/* MODAL M√ÅQUINA */}
      {selectedMachine && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-slate-900/60 backdrop-blur-md animate-fadeIn">
          <div className="absolute inset-0" onClick={() => setSelectedMachine(null)}></div>
          <div className="bg-white w-full max-w-sm rounded-t-[2.5rem] sm:rounded-[2.5rem] shadow-2xl overflow-hidden animate-slideUp z-10 max-h-[90vh] overflow-y-auto">
            <div className="relative p-8 pb-0">
               <button onClick={() => setSelectedMachine(null)} className="absolute top-6 right-6 p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 transition-colors"><X size={24} /></button>
               <h3 className="text-2xl font-bold text-slate-800 pr-12">{machineVisuals[selectedMachine]?.name}</h3>
            </div>
            <div className="p-8">
              {renderMachineModalContent(selectedMachine)}
            </div>
          </div>
        </div>
      )}

      {/* MODAL ESTAD√çSTICAS */}
      {showStats && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-slate-900/60 backdrop-blur-md animate-fadeIn">
          <div className="absolute inset-0" onClick={() => setShowStats(false)}></div>
          <div className="bg-white w-full max-w-sm rounded-t-[2.5rem] sm:rounded-[2.5rem] shadow-2xl overflow-hidden animate-slideUp z-10 max-h-[90vh] overflow-y-auto">
            <div className="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
              <div><h3 className="text-xl font-black text-slate-800">Tu Evoluci√≥n</h3><p className="text-xs text-slate-400 uppercase font-bold tracking-wider">Estad√≠sticas</p></div>
              <button onClick={() => setShowStats(false)} className="p-2 bg-white rounded-full text-slate-400 hover:text-slate-600 shadow-sm border border-slate-100"><X size={20} /></button>
            </div>
            <div className="p-6 space-y-6">
              <div className="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm relative overflow-hidden">
                <div className="flex justify-between items-end mb-2 relative z-10">
                   <div><p className="text-xs text-slate-400 font-bold uppercase">IMC Actual</p><p className="text-3xl font-black text-slate-800">{userProfile.bmi}</p></div>
                   <div className="text-right"><p className="text-xs text-slate-400 font-bold uppercase">Meta Saludable</p><p className="text-xl font-bold text-red-600">18.5 - 24.9</p></div>
                </div>
                <div className="h-4 bg-slate-100 rounded-full w-full overflow-hidden relative mt-2">
                   <div className="absolute top-0 bottom-0 left-0 w-[40%] bg-blue-200"></div><div className="absolute top-0 bottom-0 left-[40%] w-[20%] bg-green-400"></div><div className="absolute top-0 bottom-0 left-[60%] w-[20%] bg-yellow-400"></div><div className="absolute top-0 bottom-0 left-[80%] w-[20%] bg-red-400"></div>
                   <div className="absolute top-0 bottom-0 w-1 bg-slate-900 z-10 shadow-[0_0_10px_rgba(0,0,0,0.5)]" style={{ left: `${Math.min(Math.max((userProfile.bmi / 40) * 100, 0), 100)}%` }}></div>
                </div>
              </div>
              <div className="flex bg-slate-50 p-1 rounded-xl border border-slate-200">
                <button onClick={() => setStatsView('chart')} className={`flex-1 py-2 text-xs font-bold rounded-lg flex items-center justify-center gap-2 ${statsView === 'chart' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}><LineChart size={14} /> Infograf√≠a</button>
                <button onClick={() => setStatsView('list')} className={`flex-1 py-2 text-xs font-bold rounded-lg flex items-center justify-center gap-2 ${statsView === 'list' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}><List size={14} /> Historial</button>
              </div>
              {statsView === 'chart' && <div className="bg-white border border-slate-100 rounded-3xl p-4 shadow-sm"><WeightChart data={weightHistory} /></div>}
              {statsView === 'list' && <div className="bg-white border border-slate-100 rounded-3xl overflow-hidden shadow-sm"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-400 text-xs uppercase font-bold"><tr><th className="px-4 py-3">Fecha</th><th className="px-4 py-3 text-center">Peso</th><th className="px-4 py-3 text-right">IMC</th></tr></thead><tbody className="divide-y divide-slate-100">{weightHistory.slice().reverse().map((entry, i) => (<tr key={i}><td className="px-4 py-3 font-medium text-slate-600">{entry.date}</td><td className="px-4 py-3 text-center font-bold text-slate-800">{entry.weight} kg</td><td className="px-4 py-3 text-right text-slate-500">{entry.bmi}</td></tr>))}</tbody></table></div>}
              <div className="pt-4 border-t border-slate-100">
                <p className="text-xs text-slate-400 font-bold uppercase mb-3 text-center">Actualizar Peso Hoy</p>
                <div className="flex gap-2 justify-center">
                  <input type="number" inputMode="decimal" step="0.1" placeholder="Nuevo peso..." className="w-32 bg-slate-50 border border-slate-200 rounded-xl px-4 text-center text-lg font-bold outline-none focus:ring-2 focus:ring-blue-100" value={tempWeight} onChange={(e) => setTempWeight(e.target.value)} />
                  <button onClick={handleWeightSave} className="bg-blue-600 text-white px-6 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-transform">Guardar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default GymAppVisual;
